name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # Set this to your main branch
  workflow_dispatch:

permissions:
  contents: write  # This is crucial for allowing the action to push to your repository

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install Dependencies
        run: npm install

      - name: Create Static Build
        run: |
          # Create a build directory
          mkdir -p build

          # Create .nojekyll file to disable Jekyll processing
          touch build/.nojekyll

          # If you have a build script in package.json, use it instead
          if grep -q "\"build\"" package.json; then
            echo "Running npm build script..."
            npm run build
          else
            # Copy static assets
            echo "Copying static assets..."
            cp -r public/* build/ || true
            cp index.html build/ || true
            cp styles.css build/ || true
            mkdir -p build/js
            cp js/main.js build/js/ || true

            # Ensure index.html exists in build directory
            if [ ! -f build/index.html ]; then
              echo "Creating index.html in build directory..."
              if [ -f index.html ]; then
                cp index.html build/
              elif [ -f views/index.ejs ]; then
                echo "Converting EJS to HTML..."
                node -e "
                  const fs = require('fs');
                  const ejs = require('ejs');
                  try {
                    if (fs.existsSync('views/index.ejs')) {
                      const template = fs.readFileSync('views/index.ejs', 'utf8');
                      const html = ejs.render(template, {});
                      fs.writeFileSync('build/index.html', html);
                      console.log('Created index.html from EJS template');
                    }
                  } catch (err) {
                    console.error('Error creating index.html:', err);
                    // Create a simple index.html as fallback
                    fs.writeFileSync('build/index.html', '<html><head><title>HomieStay</title></head><body><h1>Welcome to HomieStay</h1><p>Site is under construction</p></body></html>');
                    console.log('Created fallback index.html');
                  }
                " || true
              else
                # Create a basic index.html as last resort
                echo "<html><head><title>HomieStay</title></head><body><h1>Welcome to HomieStay</h1><p>Site is under construction</p></body></html>" > build/index.html
                echo "Created basic index.html fallback"
              fi
            fi
          fi

          # If using a SPA (Single Page Application) like React, copy index.html to 404.html
          # to handle client-side routing on GitHub Pages
          if [ -f build/index.html ]; then
            cp build/index.html build/404.html || true
          fi

          # List files in build directory for debugging
          echo "Contents of build directory:"
          ls -la build/

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build